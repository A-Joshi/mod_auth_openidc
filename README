mod_auth_openidc is an authentication/authorization module for the Apache 2.x
HTTP server that allows users to authenticate using an OpenID Connect enabled
Identity Provider


Disclaimer:
This software is open sourced by Ping Identity but not supported commercially
as such. Any questions/issues should go to the author (hzandbelt@pingidentity.com)
directly or on to the Github Issues section for this project. See also the 
DISCLAIMER file in this directory.


This module enables an Apache web server to operate as an OpenID Connect Relying
Party using the OpenID Connect Basic Client, Implicit Client profile or Hybrid flows.

It sets the REMOTE_USER variable to the id_token sub claim. Other id_token
claims are passed in HTTP headers together with those (optionally) obtained
from the user info endpoint

It allows for authorization rules (based on standard Apache Requires primitives)
that can be matched against the set of claims provided in the id_token/userinfo.

It supports multiple OpenID Connect Providers by reading provider metadata files
from a metadata directory (configured in OIDCMetadataDir).

It supports OpenID Connect Dynamic Client Registration and OpenID Provider
Discovery through domain or account names.

Additionally it can operate as an OAuth 2.0 Resource Server to a PingFederate
OAuth 2.0 Authorization Server, validating Bearer access_tokens against
PingFederate. In that case it sets the REMOTE_USER variable to the "Username"
claim and matches the claims in the intro-spected access_token against the
Requires primitive.

It implements server-side caching across different Apache processes through one
of the following options:
 a) shared memory (default): shared across a single logical Apache server running
    as multiple Apache processes (using mpm_prefork) on the same machine
 b) file storage: in a temp directory - possibly a shared file system across
    multiple Apache processes and/or servers
 c) memcache: shared across multiple Apache processes and/or servers, possibly
    across different memcache servers living on different machines



For an exhaustive description of all configuration options, see the file
  auth_openidc.conf
in this directory. This file can alse serve as an include file for httpd.conf.



==========================================================
Sample Config for Google Accounts
==========================================================

Example config for using Google as your OpenID Connect Provider running on
localhost and https://localhost/example/redirect_uri/ registered as the
"redirect_uri" for the client through the Google API Console.

==========================================================
OIDCProviderIssuer accounts.google.com
OIDCProviderAuthorizationEndpoint https://accounts.google.com/o/oauth2/auth?approval_prompt=force&[hd=<your-domain>]
OIDCProviderTokenEndpoint https://accounts.google.com/o/oauth2/token
OIDCProviderTokenEndpointAuth client_secret_post
OIDCProviderUserInfoEndpoint https://www.googleapis.com/plus/v1/people/me/openIdConnect
OIDCProviderJwksUri https://www.googleapis.com/oauth2/v2/certs

OIDCClientID <your-client-id-administered-through-the-google-api-console>
OIDCClientSecret <your-client-secret-administered-through-the-google-api-console>

OIDCScope "openid email profile"
OIDCRedirectURI https://localhost/example/redirect_uri/
OIDCCryptoPassphrase <password>

<Location /example/>
   Authtype openid-connect
   require valid-user
</Location>
==========================================================



==========================================================
Sample Config for multiple OpenID Connect Providers
==========================================================

Another example using multiple OpenID Connect providers, which triggers
OP discovery first:

OIDCMetadataDir points to a directory that contains files that contain
per-provider configuration data. For each provider, there are 3 types of
files in the directory:

1.  <url-encoded-issuer-value-with-https-prefix-and-trailing-slash-stripped>.provider:
contains (standardized) OpenID Connect Discovery OP JSON metadata where each
name of the file is the url-encoded issuer name of the OP that is described
by the metadata in that file.

2.  <url-encoded-issuer-value-with-https-prefix-and-trailing-slash-stripped>.client:
contains Dynamic Client Registration specific JSON metadata (based on the OpenID
Connect Client Registration specification) and the filename
is the url-encoded issuer name of the OP that this client is registered with.

Sample client metdata for issuer https://localhost:9031, so the client metadata
filename is: "localhost%3A9031.client"
==========================================================
{
  "client_id" : "ac_oic_client",
  "client_secret" : "abc123DEFghijklmnop4567rstuvwxyzZYXWUT8910SRQPOnmlijhoauthplaygroundapplication",
}

3.  <url-encoded-issuer-value-with-https-prefix-and-trailing-slash-stripped>.conf:
contains mod_auth_openidc specific JSON custom metadata that can be used to overrule
some of the settings defined in auth_openidc.conf on a per-client basis. The filename
is the urlencoded issuer name of the OP that this client is registered with.

Entries that can be included in the .conf file are:
  "ssl_validate_server"                overrides OIDCSSLValidateServer on a per-client basis (value is integer 0 or 1 in this case...)
  "scope"                              overrides OIDCScope on a per-client basis 
  "response_type"                      overrides OIDCResponseType on a per-client basis 
  "response_mode"                      overrides OIDCResponseMode on a per-client basis 
  "client_name"                        overrides OIDCClientName on a per-client basis 
  "client_contact"                     overrides OIDCClientContact on a per-client basis 
  "idtoken_iat_slack"                  overrides OIDCIDTokenIatSlack on a per-client basis
  "jwks_refresh_interval"              overrides OIDCJWKSRefreshInterval on a per-client basis
  "registration_token"                 an access_token that will be used on client registration calls for this OP
  "id_token_signed_response_alg"       overrides OIDCIDTokenSignedResponseAlg on a per-client basis
  "id_token_encrypted_response_alg"    overrides OIDCIDTokenEncryptedResponseAlg on a per-client basis
  "id_token_encrypted_response_enc"    overrides OIDCIDTokenEncryptedResponseEnc on a per-client basis
  "userinfo_signed_response_alg"       overrides OIDCUserInfoSignedResponseAlg on a per-client basis
  "userinfo_encrypted_response_alg"    overrides OIDCUserInfoEncryptedResponseAlg on a per-client basis
  "userinfo_encrypted_response_enc"    overrides OIDCUserInfoEncryptedResponseEnc on a per-client basis

Sample client metdata for issuer https://localhost:9031, so the client metadata
filename is: "localhost%3A9031.conf"
==========================================================
{
  "ssl_validate_server" : 0,
  "scope" : "openid email profile",
}
  
==========================================================

And the related mod_auth_openidc Apache config section:
==========================================================
OIDCMetadataDir <somewhere-writable-for-the-apache-process>/metadata

OIDCRedirectURI https://localhost/example/redirect_uri/
OIDCCryptoPassphrase <password>

<Location /example/>
   Authtype openid-connect
   require valid-user
</Location>
==========================================================

If you do not want to use the internal discovery page, you can have the user
being redirected to an external discovery page by setting "OIDCDiscoveryURL".
That URL will be accessed with 2 parameters, "oidc_callback" and "oidc_return"
(both URLs). The "oidc_return" parameter needs to be returned to the
"oidc_callback" URL (again in the oidc_return parameter) together with an
"oidc_provider" parameter that contains the URL-encoded issuer value of the
selected Provider, or a URL-encoded account name for OpenID Connect Discovery
purposes (aka. e-mail style identifier), or a domain name.

Sample callback:
  ${oidc_callback}?oidc_return=${oidc_return}&oidc_provider=[${issuer}|${domain}|${e-mail-style-account-name}]



==========================================================
Sample Config for PingFederate OpenID Connect & OAuth 2.0
==========================================================

Another example config for using PingFederate as your OpenID OP and/or
OAuth 2.0 Authorization server, based on the OAuth 2.0 PlayGround 3.x default
configuration and doing claims-based authorization. (running on localhost and
https://localhost/example/redirect_uri/ registered as redirect_uri for the
client "ac_oic_client")

==========================================================
OIDCProviderIssuer https://macbook:9031
OIDCProviderAuthorizationEndpoint https://macbook:9031/as/authorization.oauth2
OIDCProviderTokenEndpoint https://macbook:9031/as/token.oauth2
OIDCProviderTokenEndpointAuth client_secret_basic
OIDCProviderUserInfoEndpoint https://macbook:9031/idp/userinfo.openid
OIDCProviderJwksUri https://macbook:9031/pf/JWKS

OIDCSSLValidateServer Off
OIDCClientID ac_oic_client
OIDCClientSecret abc123DEFghijklmnop4567rstuvwxyzZYXWUT8910SRQPOnmlijhoauthplaygroundapplication

OIDCRedirectURI https://localhost/example/redirect_uri/
OIDCCryptoPassphrase <password>
OIDCScope "openid email profile"

OIDCOAuthEndpoint https://macbook:9031/as/token.oauth2
OIDCOAuthEndpointAuth client_secret_basic

OIDCOAuthSSLValidateServer Off
OIDCOAuthClientID rs_client
OIDCOAuthClientSecret 2Federate

<Location /example/>
   Authtype openid-connect
   #require valid-user
   require claim sub:joe
</Location>

<Location /example2>
   Authtype oauth20
   #require valid-user
   require claim Username:joe
</Location>
==========================================================
